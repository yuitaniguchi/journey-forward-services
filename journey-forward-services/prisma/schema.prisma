generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  
}

/* ===== Enums ===== */
enum ServiceType {
  PICKUP
  PICKUP_DELIVERY
}

enum RequestStatus {
  RECEIVED
  QUOTED
  CONFIRMED
  INVOICED
  PAID
  CANCELLED
}

/* ===== Models ===== */

/** 顧客 */
model Customer {
  id        String    @id @default(cuid())
  name      String
  email     String    @unique
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  requests  Request[]
}

model Request {
  id                    String        @id @default(cuid())
  customerId            String
  customer              Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // ① enum化
  serviceType           ServiceType

  address               String
  floor                 String?
  hasElevator           Boolean       @default(false)
  preferredDate         DateTime
  preferredTime         String

  // ① enum化 ＋ ② index
  status                RequestStatus @default(RECEIVED)

  // ③ 金額系はDecimalに変更（Postgresなら@db.Decimal(10,2)など）
  quotedAmount          Decimal?      @db.Decimal(10, 2)
  finalAmount           Decimal?      @db.Decimal(10, 2)
  cancellationFee       Decimal?      @db.Decimal(10, 2)

  quotationSentAt       DateTime?
  confirmedAt           DateTime?
  invoicedAt            DateTime?
  paidAt                DateTime?
  cancelledAt           DateTime?

  stripePaymentIntentId String?
  stripeChargeId        String?

  notes                 String?
  adminNotes            String?

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  items                 Item[]

  @@index([status])                       // ②
  @@index([customerId, preferredDate])    // （運用でよく効くのでおまけ）
}

/** アイテム（品目） */
model Item {
  id          String   @id @default(cuid())
  requestId   String
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  name        String
  size        String
  imageUrl    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([requestId])
}
