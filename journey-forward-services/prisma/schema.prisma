// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/* ===== Enums ===== */
enum ServiceType {
  PICKUP
  PICKUP_DELIVERY
}

enum RequestStatus {
  RECEIVED
  QUOTED
  CONFIRMED
  INVOICED
  PAID
  CANCELLED
}

/* ===== Models ===== */

/** 顧客 */
model Customer {
  id        String    @id @default(cuid()) @map("customer_id")
  name      String
  email     String    @unique
  phone     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt      @map("updated_at")

  requests  Request[]

  @@map("customer")
}

/** 依頼（案件） */
model Request {
  id                        String        @id @default(cuid()) @map("request_id")
  customerId                String        @map("customer_id")
  customer                  Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  serviceType               ServiceType   @map("service_type")
  pickupAddress             String        @map("pickup_address")
  deliveryAddress           String        @map("delivery_address")
  preferredDatetime         DateTime      @map("preferred_datetime")

  status                    RequestStatus @default(RECEIVED)
  requestInitiatedAt        DateTime?     @map("request_initiated_at")
  freeCancellationValidUntil DateTime?    @map("free_cancellation_valid_until")

  finalAmount               Decimal?      @db.Decimal(10, 2) @map("final_amount")

  createdAt                 DateTime      @default(now())    @map("created_at")
  updatedAt                 DateTime      @updatedAt         @map("updated_at")

  items         Item[]
  quotations    Quotation[]
  payments      Payment[]
  notifications Notification[]

  @@index([status])
  @@index([customerId, preferredDatetime])
  @@map("request")
}

/** 品目 */
model Item {
  id          String   @id @default(cuid()) @map("item_id")
  requestId   String   @map("request_id")
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  name        String
  description String?
  size        String
  quantity    Int
  photoUrl    String?  @map("photo_url")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt      @map("updated_at")

  @@index([requestId])
  @@map("item")
}

/** 見積 */
model Quotation {
  id                String   @id @default(cuid()) @map("quotation_id")
  requestId         String   @map("request_id")
  request           Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  estimatedPrice    Decimal  @db.Decimal(10, 2) @map("estimated_price")
  uniqueBookingLink String   @map("unique_booking_link")
  emailSentAt       DateTime? @map("email_sent_at")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt      @map("updated_at")

  @@index([requestId])
  @@map("quotation")
}

/** 入金（実績） */
model Payment {
  id                    String   @id @default(cuid()) @map("payment_id")
  requestId             String   @map("request_id")
  request               Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  amount                Decimal  @db.Decimal(10, 2)
  currency              String   @default("JPY")
  status                String
  stripePaymentIntentId String?  @map("stripe_payment_intent_id")
  paymentMethod         String   @map("payment_method")

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt      @map("updated_at")

  @@index([requestId, status])
  @@map("payment")
}

/** 管理ユーザー */
model Admin {
  id           String   @id @default(cuid()) @map("admin_id")
  username     String   @unique
  passwordHash String   @map("password_hash")
  email        String   @unique
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt      @map("updated_at")

  @@map("admin")
}

/** 通知ログ */
model Notification {
  id            String    @id @default(cuid()) @map("notification_id")
  requestId     String?   @map("request_id")
  request       Request?  @relation(fields: [requestId], references: [id], onDelete: SetNull)

  type          String
  recipientType String    @map("recipient_type") // "CUSTOMER" / "ADMIN" など
  sentAt        DateTime? @map("sent_at")
  status        String

  @@index([requestId])
  @@map("notification")
}
